<!DOCTYPE html>
<html>
    
    <head>
        <style ype="text/css">
            #wave { width: 800px; height: 400px; border: 1px solid black; }
            .inf { text-align: right; padding-right: 1em }
            .min, .max { width: 3em }
            .min { text-align: right }
            .max { text-align: left }
            .val input { width: 100% }
            #infY { vertical-align: top; text-align: right; padding-right: 2pt }
            #infX { vertical-align: bottom; text-align: left; padding-left: 2pt }
            #controls { text-align: center } 
        </style>
        <script type="text/javascript" src="html5slider.js"></script>
        <script type="text/javascript" src="freq.js"></script>
        <script type="text/javascript">
            Freq.maxRate = Freq(4000);

            window.addEventListener('load', function () {
            
                var canvas = document.getElementById('wave'),
                    context = canvas.getContext('2d'),
                    worker = new Worker('freqs.worker.js'),
                    timeWidth = 0.01;

                context.scale(canvas.width / (timeWidth * 2 * Freq.maxRate), -canvas.height / 2);
                context.translate(0, -1);
                context.fillStyle = '#00F';

                worker.postMessage({
                    type: 'init',
                    args:
                    [
                        Number(Freq.maxRate),
                        [
                            {freq: 261, delay: 0},
                            {freq: 440, delay: 0}
                        ]
                    ]
                });

                ['volume', 'tau'].forEach(function(id) {
                    var label = document.getElementById(id + 'Label'),
                        input = label.control,
                        k = 1 / (input.getAttribute('data-scaled') || 1);
                    
                    function inputChange() {
                        localStorage[id] = input.value;
                        var scaled = k * input.value;
                        worker.postMessage({type: 'set', args: [id, scaled]});
                        label.innerHTML = scaled.toFixed(2);
                    }
                    
                    if (id in localStorage) {
                        input.value = localStorage[id];
                    }
                    
                    inputChange();
                    input.addEventListener('change', inputChange);
                });

                var msgHandler = {
                    callback: function (offset, buffer) {
                        audioDestination.writeAudio(buffer);

                        for (var i = 0; i < buffer.length; i++) {
                            context.fillRect(offset + i, 0, 1, buffer[i]);
                        }
                    }
                };
                
                worker.onmessage = function (event) {
                    var funcName = event.data.type;
                    var handler = funcName in msgHandler ? msgHandler : console;
                    handler[funcName].apply(handler, event.data.args);
                }

                var audioDestination = new AudioStream(function (start, available) {
                    worker.postMessage({type: 'audio', args: [start, available]});
                });
                
                document.getElementById('start').addEventListener('click', function() {
                    if(!audioDestination.dynamic.paused) {
                        context.save();
                        context.setTransform(1, 0, 0, 1, 0, 0);
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        context.restore();
                    }
                });

                ['start', 'pause', 'stop'].forEach(function(id) {
                    document.getElementById(id).addEventListener('click', audioDestination.dynamic[id].bind(audioDestination.dynamic));
                });
            });
        </script>
    </head>
    
    <body>
        <table>
            <tr>
                <td id="controls" colspan="5">
                    <button id="start">Start</button>
                    <button id="pause">Pause</button>
                    <button id="stop">Stop</button>
                </td>
            </tr>
            <tr>
                <th class="inf">Volume (<label id="volumeLabel" for="volume">1.00</label>)</th>
                <td class="min">0</td>
                <td class="val"><input id="volume" type="range" value="100" data-scaled="100" /></td>
                <td class="max">100</td>
                <td></td>
            </tr>
            <tr>
                <th class="inf">Tau (<label id="tauLabel" for="tau">0.75</label>)</th>
                <td class="min">50</td>
                <td class="val"><input id="tau" type="range" min="50" max="150" value="75" data-scaled="100" /></td>
                <td class="max">150</td>
                <td></td>
            </tr>
            <tr style="height: 1em"></tr>
            <tr>
                <th id="infY">p(t)</th>
                <td colspan="3"><canvas id="wave"></canvas></td>
                <th id="infX">T</th>
            </tr>
        </table>
    </body>

</html>